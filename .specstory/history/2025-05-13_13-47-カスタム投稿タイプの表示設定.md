<!-- Generated by SpecStory -->

# カスタム投稿タイプの表示設定 (2025-05-13 22:47:22)

_**User**_

@archive-staff.php 
staff-list__itemsはカスタム投稿を表示させるようにしてください
投稿タイプスラッグは　staffです
もう、プラグインでカスタム投稿設定はしているので
サブループorループで呼び出す記述を書いて

---

_**Assistant**_



---

```php:archive-staff.php
// ... existing code ...
            <div class="staff-list__container">
                <div class="staff-list__items">
                    <?php
                    // カスタム投稿タイプ「staff」の投稿を取得
                    $args = array(
                        'post_type' => 'staff',
                        'posts_per_page' => -1, // すべての投稿を表示
                    );
                    
                    // カテゴリーフィルターが設定されている場合
                    if (isset($_GET['category']) && !empty($_GET['category'])) {
                        $args['tax_query'][] = array(
                            'taxonomy' => 'staff_category',
                            'field' => 'slug',
                            'terms' => sanitize_text_field($_GET['category']),
                        );
                    }
                    
                    // タグフィルターが設定されている場合
                    if (isset($_GET['tag']) && !empty($_GET['tag'])) {
                        $args['tax_query'][] = array(
                            'taxonomy' => 'staff_tag',
                            'field' => 'slug',
                            'terms' => sanitize_text_field($_GET['tag']),
                        );
                    }
                    
                    $staff_query = new WP_Query($args);
                    
                    if ($staff_query->have_posts()) :
                        while ($staff_query->have_posts()) : $staff_query->the_post();
                            // アイキャッチ画像を取得
                            $thumbnail = get_the_post_thumbnail_url() ? get_the_post_thumbnail_url() : get_theme_file_uri('/images/sakura-staff-img.jpg');
                            
                            // ポジション情報を取得（カスタムフィールドの例）
                            $position = get_field('position') ? get_field('position') : '執行役員';
                    ?>
                    <div class="staff-list__item">
                        <div class="staff-list__item-img">
                            <a href="<?php the_permalink(); ?>">
                                <img src="<?php echo esc_url($thumbnail); ?>" alt="<?php the_title_attribute(); ?>">
                            </a>
                        </div>
                        <div class="staff-list__item-text-wrap">
                            <p class="staff-list__item-text"><?php echo esc_html($position); ?></p>
                            <h3 class="staff-list__item-name">
                                <a href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
                            </h3>
                        </div>
                    </div>
                    <?php
                        endwhile;
                        wp_reset_postdata();
                    else:
                    ?>
                    <div class="staff-list__no-results">
                        <p>該当するスタッフが見つかりませんでした。</p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
// ... existing code ...
```

---

_**User**_


Fatal error
: Uncaught Error: Call to undefined function get_field() in /var/www/html/wp-content/themes/sakura-wordpress/archive-staff.php:91 Stack trace: #0 /var/www/html/wp-includes/template-loader.php(106): include() #1 /var/www/html/wp-blog-header.php(19): require_once('/var/www/html/w...') #2 /var/www/html/index.php(17): require('/var/www/html/w...') #3 {main} thrown in
/var/www/html/wp-content/themes/sakura-wordpress/archive-staff.php
on line
91


このエラー出てる

---

_**Assistant**_



---

```php:archive-staff.php
// ... existing code ...
                    <?php
                    // カスタム投稿タイプ「staff」の投稿を取得
                    $args = array(
                        'post_type' => 'staff',
                        'posts_per_page' => -1, // すべての投稿を表示
                    );
                    
                    // カテゴリーフィルターが設定されている場合
                    if (isset($_GET['category']) && !empty($_GET['category'])) {
                        $args['tax_query'][] = array(
                            'taxonomy' => 'staff_category',
                            'field' => 'slug',
                            'terms' => sanitize_text_field($_GET['category']),
                        );
                    }
                    
                    // タグフィルターが設定されている場合
                    if (isset($_GET['tag']) && !empty($_GET['tag'])) {
                        $args['tax_query'][] = array(
                            'taxonomy' => 'staff_tag',
                            'field' => 'slug',
                            'terms' => sanitize_text_field($_GET['tag']),
                        );
                    }
                    
                    $staff_query = new WP_Query($args);
                    
                    if ($staff_query->have_posts()) :
                        while ($staff_query->have_posts()) : $staff_query->the_post();
                            // アイキャッチ画像を取得
                            $thumbnail = get_the_post_thumbnail_url() ? get_the_post_thumbnail_url() : get_theme_file_uri('/images/sakura-staff-img.jpg');
                            
                            // ポジション情報を取得（標準のカスタムフィールド）
                            $position = get_post_meta(get_the_ID(), 'position', true);
                            if (empty($position)) $position = '執行役員';
                    ?>
                    <div class="staff-list__item">
                        <div class="staff-list__item-img">
                            <a href="<?php the_permalink(); ?>">
                                <img src="<?php echo esc_url($thumbnail); ?>" alt="<?php the_title_attribute(); ?>">
                            </a>
                        </div>
                        <div class="staff-list__item-text-wrap">
                            <p class="staff-list__item-text"><?php echo esc_html($position); ?></p>
                            <h3 class="staff-list__item-name">
                                <a href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
                            </h3>
                        </div>
                    </div>
                    <?php
                        endwhile;
                        wp_reset_postdata();
                    else:
                    ?>
                    <div class="staff-list__no-results">
                        <p>該当するスタッフが見つかりませんでした。</p>
                    </div>
                    <?php endif; ?>
// ... existing code ...
```

---

_**User**_

<p class="staff-list__item-text"><?php echo esc_html($position); ?></p>
のpositionはカテゴリー（スタップ）のタクソノミーです
スラッグはcategory-staffです
ない場合はありませんと表示するようにして

---

_**Assistant**_



---

```php:archive-staff.php
// ... existing code ...
                    <?php
                    // カスタム投稿タイプ「staff」の投稿を取得
                    $args = array(
                        'post_type' => 'staff',
                        'posts_per_page' => -1, // すべての投稿を表示
                    );
                    
                    // カテゴリーフィルターが設定されている場合
                    if (isset($_GET['category']) && !empty($_GET['category'])) {
                        $args['tax_query'][] = array(
                            'taxonomy' => 'staff_category',
                            'field' => 'slug',
                            'terms' => sanitize_text_field($_GET['category']),
                        );
                    }
                    
                    // タグフィルターが設定されている場合
                    if (isset($_GET['tag']) && !empty($_GET['tag'])) {
                        $args['tax_query'][] = array(
                            'taxonomy' => 'staff_tag',
                            'field' => 'slug',
                            'terms' => sanitize_text_field($_GET['tag']),
                        );
                    }
                    
                    $staff_query = new WP_Query($args);
                    
                    if ($staff_query->have_posts()) :
                        while ($staff_query->have_posts()) : $staff_query->the_post();
                            // アイキャッチ画像を取得
                            $thumbnail = get_the_post_thumbnail_url() ? get_the_post_thumbnail_url() : get_theme_file_uri('/images/sakura-staff-img.jpg');
                            
                            // タクソノミーからポジション情報を取得
                            $position_terms = get_the_terms(get_the_ID(), 'category-staff');
                            $position = 'ありません';
                            if ($position_terms && !is_wp_error($position_terms)) {
                                $position = $position_terms[0]->name;
                            }
                    ?>
                    <div class="staff-list__item">
                        <div class="staff-list__item-img">
                            <a href="<?php the_permalink(); ?>">
                                <img src="<?php echo esc_url($thumbnail); ?>" alt="<?php the_title_attribute(); ?>">
                            </a>
                        </div>
                        <div class="staff-list__item-text-wrap">
                            <p class="staff-list__item-text"><?php echo esc_html($position); ?></p>
                            <h3 class="staff-list__item-name">
                                <a href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
                            </h3>
                        </div>
                    </div>
                    <?php
                        endwhile;
                        wp_reset_postdata();
                    else:
                    ?>
                    <div class="staff-list__no-results">
                        <p>該当するスタッフが見つかりませんでした。</p>
                    </div>
                    <?php endif; ?>
// ... existing code ...
```

---

_**User**_

検索がうまく機能してないですね

検索したらstaff-list__itemが表示されず
該当しませんと出ます

---

_**Assistant**_



---

```php:archive-staff.php
// ... existing code ...
                    <?php
                    // カスタム投稿タイプ「staff」の投稿を取得
                    $args = array(
                        'post_type' => 'staff',
                        'posts_per_page' => -1, // すべての投稿を表示
                    );
                    
                    // カテゴリーフィルターが設定されている場合
                    if (isset($_GET['category']) && !empty($_GET['category'])) {
                        $args['tax_query'][] = array(
                            'taxonomy' => 'category-staff', // タクソノミー名を修正
                            'field' => 'slug',
                            'terms' => sanitize_text_field($_GET['category']),
                        );
                    }
                    
                    // タグフィルターが設定されている場合
                    if (isset($_GET['tag']) && !empty($_GET['tag'])) {
                        $args['tax_query'][] = array(
                            'taxonomy' => 'tags-staff', // タクソノミー名を修正
                            'field' => 'slug',
                            'terms' => sanitize_text_field($_GET['tag']),
                        );
                    }
                    
                    $staff_query = new WP_Query($args);
                    
                    if ($staff_query->have_posts()) :
                        while ($staff_query->have_posts()) : $staff_query->the_post();
                            // アイキャッチ画像を取得
                            $thumbnail = get_the_post_thumbnail_url() ? get_the_post_thumbnail_url() : get_theme_file_uri('/images/sakura-staff-img.jpg');
                            
                            // タクソノミーからポジション情報を取得
                            $position_terms = get_the_terms(get_the_ID(), 'category-staff');
                            $position = 'ありません';
                            if ($position_terms && !is_wp_error($position_terms)) {
                                $position = $position_terms[0]->name;
                            }
                    ?>
                    <div class="staff-list__item">
                        <div class="staff-list__item-img">
                            <a href="<?php the_permalink(); ?>">
                                <img src="<?php echo esc_url($thumbnail); ?>" alt="<?php the_title_attribute(); ?>">
                            </a>
                        </div>
                        <div class="staff-list__item-text-wrap">
                            <p class="staff-list__item-text"><?php echo esc_html($position); ?></p>
                            <h3 class="staff-list__item-name">
                                <a href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
                            </h3>
                        </div>
                    </div>
                    <?php
                        endwhile;
                        wp_reset_postdata();
                    else:
                    ?>
                    <div class="staff-list__no-results">
                        <p>該当するスタッフが見つかりませんでした。</p>
                    </div>
                    <?php endif; ?>
// ... existing code ...
```

---

_**User**_

 @archive-staff.php 
tagは検索すると４０４ページに飛んでしまう

---

_**Assistant**_



---

```php:archive-staff.php
<?php get_header(); ?>

<!-- メインコンテンツ -->
<main class="staff-archive">
    <section id="section1" class="staff-hero">
        <div class="staff-hero__inner inner">
            <div class="staff-hero__content">
                <div class="staff-hero__title-wrapper">
                    <h3 class="staff-hero__title">OUR MEMBERS</h3>
                    <h2 class="staff-hero__subtitle">メンバー紹介</h2>
                </div>
            </div>
        </div>
    </section>

    <section id="section2" class="staff-list">
        <div class="staff-list__inner inner">
            <div class="staff-list__text-wrapper">
                <p class="staff-list__text">この文章はダミーです。文字の大きさ、量、字間、行間等を確認するために入れています。</p>
            </div>
            <div class="staff__search">
                <form action="<?php echo esc_url(get_post_type_archive_link('staff')); ?>" method="get" class="staff__search-form">
                    <div class="staff__search-category">
                        <select name="staff-category" class="staff__search-select">
                            <option value="">Category</option>
                            <?php 
                            $categories = get_terms([
                                'taxonomy' => 'category-staff',
                                'hide_empty' => true,
                            ]);
                            foreach ($categories as $category) {
                                echo '<option value="' . esc_attr($category->slug) . '">' . esc_html($category->name) . '</option>';
                            }
                            ?>
                        </select>
                    </div>
                    <div class="staff__search-tag">
                        <select name="staff-tag" class="staff__search-select">
                            <option value="">Tag</option>
                            <?php 
                            $tags = get_terms([
                                'taxonomy' => 'tags-staff',
                                'hide_empty' => true,
                            ]);
                            foreach ($tags as $tag) {
                                echo '<option value="' . esc_attr($tag->slug) . '">' . esc_html($tag->name) . '</option>';
                            }
                            ?>
                        </select>
                    </div>
                </form>
            </div>
            <div class="staff-list__container">
                <div class="staff-list__items">
                    <?php
                    // カスタム投稿タイプ「staff」の投稿を取得
                    $args = array(
                        'post_type' => 'staff',
                        'posts_per_page' => -1, // すべての投稿を表示
                    );
                    
                    // カテゴリーフィルターが設定されている場合
                    if (isset($_GET['staff-category']) && !empty($_GET['staff-category'])) {
                        $args['tax_query'][] = array(
                            'taxonomy' => 'category-staff',
                            'field' => 'slug',
                            'terms' => sanitize_text_field($_GET['staff-category']),
                        );
                    }
                    
                    // タグフィルターが設定されている場合
                    if (isset($_GET['staff-tag']) && !empty($_GET['staff-tag'])) {
                        $args['tax_query'][] = array(
                            'taxonomy' => 'tags-staff',
                            'field' => 'slug',
                            'terms' => sanitize_text_field($_GET['staff-tag']),
                        );
                    }
                    
                    $staff_query = new WP_Query($args);
                    
                    if ($staff_query->have_posts()) :
                        while ($staff_query->have_posts()) : $staff_query->the_post();
                            // アイキャッチ画像を取得
                            $thumbnail = get_the_post_thumbnail_url() ? get_the_post_thumbnail_url() : get_theme_file_uri('/images/sakura-staff-img.jpg');
                            
                            // タクソノミーからポジション情報を取得
                            $position_terms = get_the_terms(get_the_ID(), 'category-staff');
                            $position = 'ありません';
                            if ($position_terms && !is_wp_error($position_terms)) {
                                $position = $position_terms[0]->name;
                            }
                    ?>
                    <div class="staff-list__item">
                        <div class="staff-list__item-img">
                            <a href="<?php the_permalink(); ?>">
                                <img src="<?php echo esc_url($thumbnail); ?>" alt="<?php the_title_attribute(); ?>">
                            </a>
                        </div>
                        <div class="staff-list__item-text-wrap">
                            <p class="staff-list__item-text"><?php echo esc_html($position); ?></p>
                            <h3 class="staff-list__item-name">
                                <a href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
                            </h3>
                        </div>
                    </div>
                    <?php
                        endwhile;
                        wp_reset_postdata();
                    else:
                    ?>
                    <div class="staff-list__no-results">
                        <p>該当するスタッフが見つかりませんでした。</p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('.staff__search-category select');
    const tagSelect = document.querySelector('.staff__search-tag select');
    
    // カテゴリー選択変更時の処理
    categorySelect.addEventListener('change', function() {
        if (this.value) {
            document.querySelector('.staff__search-form').submit();
        }
    });
    
    // タグ選択変更時の処理
    tagSelect.addEventListener('change', function() {
        if (this.value) {
            document.querySelector('.staff__search-form').submit();
        }
    });
});
</script>

<?php get_footer(); ?>
```

---

_**User**_

@archive-staff.php 
検索は全件表示のセレクトもほしい

---

_**Assistant**_



---

```php:archive-staff.php
<!-- ... existing code ... -->
            <div class="staff__search">
                <form action="<?php echo esc_url(get_post_type_archive_link('staff')); ?>" method="get" class="staff__search-form">
                    <div class="staff__search-category">
                        <select name="staff-category" class="staff__search-select">
                            <option value="">全件表示</option>
                            <?php 
                            $categories = get_terms([
                                'taxonomy' => 'category-staff',
                                'hide_empty' => true,
                            ]);
                            foreach ($categories as $category) {
                                $selected = (isset($_GET['staff-category']) && $_GET['staff-category'] === $category->slug) ? 'selected' : '';
                                echo '<option value="' . esc_attr($category->slug) . '" ' . $selected . '>' . esc_html($category->name) . '</option>';
                            }
                            ?>
                        </select>
                    </div>
                    <div class="staff__search-tag">
                        <select name="staff-tag" class="staff__search-select">
                            <option value="">全件表示</option>
                            <?php 
                            $tags = get_terms([
                                'taxonomy' => 'tags-staff',
                                'hide_empty' => true,
                            ]);
                            foreach ($tags as $tag) {
                                $selected = (isset($_GET['staff-tag']) && $_GET['staff-tag'] === $tag->slug) ? 'selected' : '';
                                echo '<option value="' . esc_attr($tag->slug) . '" ' . $selected . '>' . esc_html($tag->name) . '</option>';
                            }
                            ?>
                        </select>
                    </div>
                    <button type="submit" class="staff__search-button">検索</button>
                </form>
            </div>
<!-- ... existing code ... -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('.staff__search-category select');
    const tagSelect = document.querySelector('.staff__search-tag select');
    const form = document.querySelector('.staff__search-form');
    
    // URLから現在のパラメータを取得
    const urlParams = new URLSearchParams(window.location.search);
    
    // 初期選択状態を設定
    if (urlParams.has('staff-category')) {
        categorySelect.value = urlParams.get('staff-category');
    }
    
    if (urlParams.has('staff-tag')) {
        tagSelect.value = urlParams.get('staff-tag');
    }
    
    // カテゴリー選択変更時の処理
    categorySelect.addEventListener('change', function() {
        form.submit();
    });
    
    // タグ選択変更時の処理
    tagSelect.addEventListener('change', function() {
        form.submit();
    });
    
    // フォーム送信前の処理
    form.addEventListener('submit', function(e) {
        // 空の値のパラメータを削除
        if (!categorySelect.value) {
            categorySelect.disabled = true;
        }
        
        if (!tagSelect.value) {
            tagSelect.disabled = true;
        }
    });
});
</script>
```

---

_**User**_

おけ
検索ボタン押したら検索が走るようにして

---

_**Assistant**_



---

```php:archive-staff.php
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('.staff__search-category select');
    const tagSelect = document.querySelector('.staff__search-tag select');
    const form = document.querySelector('.staff__search-form');
    
    // URLから現在のパラメータを取得
    const urlParams = new URLSearchParams(window.location.search);
    
    // 初期選択状態を設定
    if (urlParams.has('staff-category')) {
        categorySelect.value = urlParams.get('staff-category');
    }
    
    if (urlParams.has('staff-tag')) {
        tagSelect.value = urlParams.get('staff-tag');
    }
    
    // カテゴリーとタグの自動送信をやめ、ボタンクリック時のみ検索するように修正
    // categorySelect.addEventListener('change', function() { ... }) を削除
    // tagSelect.addEventListener('change', function() { ... }) を削除
    
    // フォーム送信前の処理
    form.addEventListener('submit', function(e) {
        // 空の値のパラメータを削除
        if (!categorySelect.value) {
            categorySelect.disabled = true;
        }
        
        if (!tagSelect.value) {
            tagSelect.disabled = true;
        }
    });
});
</script>
```

---

