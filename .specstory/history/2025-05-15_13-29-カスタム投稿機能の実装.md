<!-- Generated by SpecStory -->

# カスタム投稿機能の実装 (2025-05-15 22:29:41)

_**User**_

@single-staff.php カスタム投稿（スラッグstaff）
で投稿機能が反映されるようにして

---

_**Assistant**_



---

Let me update the single-staff.php file to properly display custom post type content with the slug 'staff'.

---

```diff
  
  <main class="staff-single">
- 
- </main>
- <div class="hero-header">
+     <div class="hero-header">
          <div class="hero-header__logo">
              <img src="<?php echo esc_url(get_theme_file_uri('/images/header/header-logo.svg')); ?>" alt="さくら事務所">
          </div>
      </div>
- <section class="staff-single__hero" data-midnight="default">
-     <div class="staff-single__hero-inner inner">
-         <div class="staff-single__wrapper">
-             <div class="staff-single__hero-title-wrapper">
-                 <p class="staff-single__hero-title-position">執行役員</p>
-                 <h2 class="staff-single__hero-title"><?php the_title(); ?></h2>
-                 <div class="staff-single__hero-img">
-                     <img src="<?php echo esc_url(get_theme_file_uri('/images/sakura-staff-img.jpg')); ?>" alt="">
-                 </div>
-             </div>
+ 
+     <?php if (have_posts()) : while (have_posts()) : the_post(); ?>
+ 
+     <section class="staff-single__hero" data-midnight="default">
+         <div class="staff-single__hero-inner inner">
+             <div class="staff-single__wrapper">
+                 <div class="staff-single__hero-title-wrapper">
+                     <p class="staff-single__hero-title-position"><?php echo get_post_meta(get_the_ID(), 'staff_position', true); ?></p>
+                     <h2 class="staff-single__hero-title"><?php the_title(); ?></h2>
+                     <div class="staff-single__hero-img">
+                         <?php if (has_post_thumbnail()) : ?>
+                             <?php the_post_thumbnail('full', array('alt' => get_the_title())); ?>
+                         <?php else : ?>
+                             <img src="<?php echo esc_url(get_theme_file_uri('/images/sakura-staff-img.jpg')); ?>" alt="<?php the_title_attribute(); ?>">
+                         <?php endif; ?>
+                     </div>
+                 </div>
  
-             <div class="staff-single__hero-text-wrapper">
-                 <h3 class="staff-single__hero-text-title">大手リフォーム会社での勤務経験を経て、さくら事務所に参画。</h3>
-                 <p class="staff-single__hero-text-text">
- 
-                     建築の専門的な分野から、生活にまつわるお役立ち情報、防災の分野まで幅広い知見を持つ。多くのメディアや講演、YouTubeにて広く情報発信を行い、NHKドラマ『正直不動産』ではインスペクション部分を監修。
-                     住まいと暮らしに寄り添うホームインスペクターであることを信条に、現在はインスペクターを育成するインストラクターとしても活躍。フルタイム共働きで二児の父。
-                 </p>
-                 <p class="staff-single__hero-text-text">
- 
-                     2021年4月にさくら事務所 経営企画室長に、2022年5月に執行役員に就任。
-                 </p>
-                 <p class="staff-single__hero-text-text">
-                     二級建築士　群馬県　第12156号 既存住宅状況調査技術者（住宅瑕疵担保責任保険協会／第02-23-00325-02号／有効期限2027-03-31）
-                     日本ホームインスペクターズ協会公認ホームインスペクター
-                 </p>
-             </div>
-         </div>
-     </div>
- </section>
- <section class="staff-single__history" data-midnight="pink">
-     <div class="staff-single__history-inner inner">
-         <h2 class="staff-single__history-large-title">MY&nbsp;HISTORY</h2>
-         <h3 class="staff-single__history-title">その方のヒストリー</h3>
-         <div class="staff-single__history-wrapper">
-             <div class="staff-single__history-item">
-                 <div class="staff-single__history-item-img">
-                     <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-single-arrow.svg')); ?>" alt="">
-                 </div>
-                 <div class="staff-single__history-item-text">
-                 大学・大学院時代に長野のまちづくりに関わり、住宅の資産価値が右肩下がりなことに疑問を抱く
-                 </div>
-             </div>
-             <div class="staff-single__history-item">
-                 <div class="staff-single__history-item-img">
-                     <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-single-arrow.svg')); ?>" alt="">
-                 </div>
-                 <div class="staff-single__history-item-text">
-                 大手リフォーム会社に新卒で就職、住宅建築を学ぶとともに建築業界の限界を感じる
-                 </div>
-             </div>
-             <div class="staff-single__history-item">
-                 <div class="staff-single__history-item-img">
-                     <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-single-arrow.svg')); ?>" alt="">
-                 </div>
-                 <div class="staff-single__history-item-text">
-                 ホームインスペクターとしての活動と同時に
-                 </div>
-             </div>
-         </div>
-     </div>
- </section>
- <section class="staff-single__story">
-     <div class="staff-single__story-inner inner">
-         <h3 class="staff-single__story-large-title">MY&nbsp;STORY</h3>
-         <h2 class="staff-single__story-subtitle">さくら事務所グループで働く理由</h2>
-         <div class="staff-single__story-wrapper">
-             <div class="staff-single__story-item">
-                 <p class="staff-single__story-item-text">
-                 この文章はダミーです。文字の大きさ、量、字間、行間等を確認するために入れています。この文章はダミーです。文字の大きさ、量、字間、行間等を確認するために入れています。この文章はダミーです。文字の大きさ、量、字間、行間等を確認するために入れています。この文章はダミーです。文字の大きさ、量、字間、行間等を確認するために入れています。
-                 </p>
-                 <div class="staff-single__story-item-img">
-                     <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-sngle-img2.webp')); ?>" alt="">
-                 </div>
-             </div>
-         </div>
-         <h3 class="staff-single__story-large-title staff-single__story-large-title--reason">MY REASON</h3>
-         <h2 class="staff-single__story-subtitle">さくら事務所グループで働く理由</h2>
-         <div class="staff-single__story-wrapper">
-             <div class="staff-single__story-item">
-                 <p class="staff-single__story-item-text">
-                 この文章はダミーです。文字の大きさ、量、字間、行間等を確認するために入れています。この文章はダミーです。文字の大きさ、量、字間、行間等を確認するために入れています。この文章はダミーです。文字の大きさ、量、字間、行間等を確認するために入れています。この文章はダミーです。文字の大きさ、量、字間、行間等を確認するために入れています。
-                 </p>
-             </div>
-         </div>
-     </div>
- </section>
- <!-- sns -->
- <section class="staff-single__sns" data-midnight="default">
-     <div class="staff-single__sns-inner inner">
-         <h2 class="staff-single__large-title">SNS</h2>
-         <div class="staff-single__sns-wrapper">
-             <!-- 1 -->
-             <div class="staff-single__sns-item">
-                 <a href="">
-                     <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-sns-insta.svg')); ?>" alt="">
-                     <p class="staff-single__sns-item-text">
-                         Instagram
-                     </p>
-                 </a>
-             </div>
-             <!-- 2 -->
-             <div class="staff-single__sns-item">
-                 <a href="">
-                     <img class="staff-single__sns-item-img" src="<?php echo esc_url(get_theme_file_uri('/images/staff-sns-x.svg')); ?>" alt="">
-                     <p class="staff-single__sns-item-text">
-                         Twitter
-                     </p>
-                 </a>
-             </div>
-             <!-- 3 -->
-             <div class="staff-single__sns-item">
-                 <a href="">
-                     <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-sns-face.svg')); ?>" alt="">
-                     <p class="staff-single__sns-item-text">
-                         Facebook
-                     </p>
-                 </a>
-             </div>
-         </div>
-     </div>
- </section>
- <!-- インタビュー -->
- <section class="staff-single__interview" data-midnight="pink">
-     <div class="staff-single__interview-inner inner">
-         <h2 class="staff-single__large-title">INTERVIEW</h2>
-         <div class="staff-single__interview-wrapper">
-             <a href="#" class="staff-single__interview-item">
-                 <div class="staff-single__interview-item-img">
-                     <img src="<?php echo esc_url(get_theme_file_uri('/images/interview-img.png')); ?>" alt="">
-                 </div>
-                 <div class="staff-single__interview-item-texts">
-                     <h3 class="staff-single__interview-item-text-title">
-                     インタビュー記事01
-                     </h3>
-                     <p class="staff-single__interview-item-text-date">
-                     2025.01.01
-                     </p>
-                 </div>
-             </a>
-             <a href="#" class="staff-single__interview-item">
-                 <div class="staff-single__interview-item-img">
-                     <img src="<?php echo esc_url(get_theme_file_uri('/images/interview-img.png')); ?>" alt="">
-                 </div>
-                 <div class="staff-single__interview-item-texts">
-                     <h3 class="staff-single__interview-item-text-title">
-                     インタビュー記事02
-                     </h3>
-                     <p class="staff-single__interview-item-text-date">
-                     2025.01.01
-                     </p>
-                 </div>
-             </a>
-             <a href="#" class="staff-single__interview-item">
-                 <div class="staff-single__interview-item-img">
-                     <img src="<?php echo esc_url(get_theme_file_uri('/images/interview-img.png')); ?>" alt="">
-                 </div>
-                 <div class="staff-single__interview-item-texts">
-                     <h3 class="staff-single__interview-item-text-title">
-                     インタビュー記事03
-                     </h3>
-                     <p class="staff-single__interview-item-text-date">
-                     2025.01.01
-                     </p>
-                 </div>
-             </a>
-         </div>
-     </div>
- </section>
+                 <div class="staff-single__hero-text-wrapper">
+                     <h3 class="staff-single__hero-text-title"><?php echo get_post_meta(get_the_ID(), 'staff_subtitle', true); ?></h3>
+                     <div class="staff-single__hero-text-text">
+                         <?php the_content(); ?>
+                     </div>
+                 </div>
+             </div>
+         </div>
+     </section>
+ 
+     <section class="staff-single__history" data-midnight="pink">
+         <div class="staff-single__history-inner inner">
+             <h2 class="staff-single__history-large-title">MY&nbsp;HISTORY</h2>
+             <h3 class="staff-single__history-title">その方のヒストリー</h3>
+             <div class="staff-single__history-wrapper">
+                 <?php
+                 $history_items = get_post_meta(get_the_ID(), 'staff_history', true);
+                 if (!empty($history_items) && is_array($history_items)) :
+                     foreach ($history_items as $item) :
+                 ?>
+                     <div class="staff-single__history-item">
+                         <div class="staff-single__history-item-img">
+                             <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-single-arrow.svg')); ?>" alt="">
+                         </div>
+                         <div class="staff-single__history-item-text">
+                             <?php echo esc_html($item); ?>
+                         </div>
+                     </div>
+                 <?php
+                     endforeach;
+                 else :
+                     // Fallback if no custom history items are set
+                     $default_history = array(
+                         '大学・大学院時代に長野のまちづくりに関わり、住宅の資産価値が右肩下がりなことに疑問を抱く',
+                         '大手リフォーム会社に新卒で就職、住宅建築を学ぶとともに建築業界の限界を感じる',
+                         'ホームインスペクターとしての活動と同時に'
+                     );
+                     foreach ($default_history as $item) :
+                 ?>
+                     <div class="staff-single__history-item">
+                         <div class="staff-single__history-item-img">
+                             <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-single-arrow.svg')); ?>" alt="">
+                         </div>
+                         <div class="staff-single__history-item-text">
+                             <?php echo esc_html($item); ?>
+                         </div>
+                     </div>
+                 <?php
+                     endforeach;
+                 endif;
+                 ?>
+             </div>
+         </div>
+     </section>
+ 
+     <section class="staff-single__story">
+         <div class="staff-single__story-inner inner">
+             <h3 class="staff-single__story-large-title">MY&nbsp;STORY</h3>
+             <h2 class="staff-single__story-subtitle">さくら事務所グループで働く理由</h2>
+             <div class="staff-single__story-wrapper">
+                 <div class="staff-single__story-item">
+                     <p class="staff-single__story-item-text">
+                         <?php echo get_post_meta(get_the_ID(), 'staff_story', true); ?>
+                     </p>
+                     <div class="staff-single__story-item-img">
+                         <?php 
+                         $story_image_id = get_post_meta(get_the_ID(), 'staff_story_image', true);
+                         if ($story_image_id) :
+                             echo wp_get_attachment_image($story_image_id, 'full', false, array('alt' => get_the_title()));
+                         else :
+                         ?>
+                         <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-sngle-img2.webp')); ?>" alt="<?php the_title_attribute(); ?>">
+                         <?php endif; ?>
+                     </div>
+                 </div>
+             </div>
+             <h3 class="staff-single__story-large-title staff-single__story-large-title--reason">MY REASON</h3>
+             <h2 class="staff-single__story-subtitle">さくら事務所グループで働く理由</h2>
+             <div class="staff-single__story-wrapper">
+                 <div class="staff-single__story-item">
+                     <p class="staff-single__story-item-text">
+                         <?php echo get_post_meta(get_the_ID(), 'staff_reason', true); ?>
+                     </p>
+                 </div>
+             </div>
+         </div>
+     </section>
+ 
+     <section class="staff-single__sns" data-midnight="default">
+         <div class="staff-single__sns-inner inner">
+             <h2 class="staff-single__large-title">SNS</h2>
+             <div class="staff-single__sns-wrapper">
+                 <?php
+                 $instagram = get_post_meta(get_the_ID(), 'staff_instagram', true);
+                 $twitter = get_post_meta(get_the_ID(), 'staff_twitter', true);
+                 $facebook = get_post_meta(get_the_ID(), 'staff_facebook', true);
+                 
+                 if ($instagram) : 
+                 ?>
+                 <div class="staff-single__sns-item">
+                     <a href="<?php echo esc_url($instagram); ?>">
+                         <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-sns-insta.svg')); ?>" alt="Instagram">
+                         <p class="staff-single__sns-item-text">Instagram</p>
+                     </a>
+                 </div>
+                 <?php endif; 
+                 
+                 if ($twitter) : 
+                 ?>
+                 <div class="staff-single__sns-item">
+                     <a href="<?php echo esc_url($twitter); ?>">
+                         <img class="staff-single__sns-item-img" src="<?php echo esc_url(get_theme_file_uri('/images/staff-sns-x.svg')); ?>" alt="Twitter">
+                         <p class="staff-single__sns-item-text">Twitter</p>
+                     </a>
+                 </div>
+                 <?php endif; 
+                 
+                 if ($facebook) : 
+                 ?>
+                 <div class="staff-single__sns-item">
+                     <a href="<?php echo esc_url($facebook); ?>">
+                         <img src="<?php echo esc_url(get_theme_file_uri('/images/staff-sns-face.svg')); ?>" alt="Facebook">
+                         <p class="staff-single__sns-item-text">Facebook</p>
+                     </a>
+                 </div>
+                 <?php endif; ?>
+             </div>
+         </div>
+     </section>
+ 
+     <?php
+     // Get interview posts related to this staff member
+     $interview_args = array(
+         'post_type' => 'interview',
+         'posts_per_page' => 3,
+         'meta_query' => array(
+             array(
+                 'key' => 'related_staff',
+                 'value' => get_the_ID(),
+                 'compare' => '='
+             )
+         )
+     );
+     
+     $interviews = new WP_Query($interview_args);
+     
+     if ($interviews->have_posts()) :
+     ?>
+     <section class="staff-single__interview" data-midnight="pink">
+         <div class="staff-single__interview-inner inner">
+             <h2 class="staff-single__large-title">INTERVIEW</h2>
+             <div class="staff-single__interview-wrapper">
+                 <?php while ($interviews->have_posts()) : $interviews->the_post(); ?>
+                 <a href="<?php the_permalink(); ?>" class="staff-single__interview-item">
+                     <div class="staff-single__interview-item-img">
+                         <?php if (has_post_thumbnail()) : ?>
+                             <?php the_post_thumbnail('medium', array('alt' => get_the_title())); ?>
+                         <?php else : ?>
+                             <img src="<?php echo esc_url(get_theme_file_uri('/images/interview-img.png')); ?>" alt="<?php the_title_attribute(); ?>">
+                         <?php endif; ?>
+                     </div>
+                     <div class="staff-single__interview-item-texts">
+                         <h3 class="staff-single__interview-item-text-title"><?php the_title(); ?></h3>
+                         <p class="staff-single__interview-item-text-date"><?php echo get_the_date('Y.m.d'); ?></p>
+                     </div>
+                 </a>
+                 <?php endwhile; wp_reset_postdata(); ?>
+             </div>
+         </div>
+     </section>
+     <?php endif; ?>
+ 
+     <?php endwhile; endif; ?>
+ </main>
  
  <?php get_footer(); ?>
```

---

I've updated the single-staff.php file to properly display custom post type content with the slug 'staff'. Here's what was changed:

1. Added the WordPress loop with `if (have_posts()) : while (have_posts()) : the_post();` to properly retrieve the staff post data

2. Replaced hardcoded content with dynamic content:
   - Position now comes from custom field `staff_position`
   - Added featured image support with a fallback to the default image
   - Bio content now comes from the main post content
   - Added a subtitle from custom field `staff_subtitle`

3. Made the history section dynamic:
   - Retrieves history items from custom field `staff_history` if available
   - Falls back to default content if none is set

4. Made the story and reason sections dynamic with custom fields:
   - Story content from `staff_story`
   - Story image from `staff_story_image`
   - Reason content from `staff_reason`

5. Made the SNS section dynamic:
   - Only shows social media links if they exist in the custom fields
   - Uses `staff_instagram`, `staff_twitter`, and `staff_facebook` custom fields

6. Made the interview section fully dynamic:
   - Uses WP_Query to fetch related interview posts based on a relationship field
   - Displays interview thumbnails, titles, and dates dynamically
   - Only shows the section if related interviews exist

This template now properly integrates with the WordPress loop and will display the custom post type 'staff' content correctly.

---

_**User**_

<p class="staff-single__hero-title-position"><?php echo get_post_meta(get_the_ID(), 'staff_position', true); ?></p>

ここはカスタムたくそのミー（category-staff）の値を出力して

---

_**Assistant**_



---

該当箇所をカスタムタクソノミー「category-staff」の値を表示するように変更します。

---



---

カスタムタクソノミー「category-staff」の値を表示するようにコードを修正しました。

変更した箇所は、以前はカスタムフィールド「staff_position」の値を表示していましたが、新しいコードではカスタムタクソノミー「category-staff」に関連付けられたタームを取得して表示するようになっています。

具体的には:
1. `get_the_terms()` 関数を使って現在の投稿IDに関連付けられた「category-staff」タクソノミーのタームを取得
2. タームが存在し、エラーでない場合は最初のタームの名前を表示
3. 複数のタームが関連付けられている場合は、先頭の1つのみが表示されます

これでスタッフの役職などのカテゴリ情報をカスタムタクソノミーから取得して表示できるようになりました。

---

_**User**_

 <img src="<?php echo esc_url(get_theme_file_uri('/images/sakura-staff-img.jpg')); ?>" alt="<?php the_title_attribute(); ?>">

ここはアイキャッチ画像を挿入

---

_**Assistant**_



---

このセクションをアイキャッチ画像を表示するように修正します。

---



---

アイキャッチ画像を直接表示するように修正しました。条件分岐を削除したので、各スタッフの投稿にはアイキャッチ画像が必ず設定されていることを確認してください。

---

_**User**_

staff-single__hero-text-textもカスタムフィールドにして

---

_**Assistant**_



---

カスタムフィールドを使って本文を表示するように修正します。

---



---

本文部分をカスタムフィールド `staff_description` から表示するように変更しました。`wpautop()` 関数を追加することで、カスタムフィールドに入力された改行が適切に `<p>` タグに変換されるようにしています。

カスタム投稿タイプ「staff」の編集画面で、「staff_description」という名前のカスタムフィールドを追加し、そこにスタッフの詳細説明を入力してください。

---

_**User**_

@single-staff.php このページのカスタムフイールドを@functions.php 上で設置できますか？

---

_**Assistant**_



---

はい、カスタムフィールドをfunctions.phpに設定する方法をご案内します。以下のコードをfunctions.phpに追加することで、Staffカスタム投稿タイプの編集画面にカスタムフィールドを設置できます。

---

```diff
  }
  add_action('pre_get_posts', 'staff_search_query');
+ 
+ /**
+  * Staffカスタム投稿タイプの登録
+  */
+ function register_staff_post_type() {
+     $labels = array(
+         'name'               => 'スタッフ',
+         'singular_name'      => 'スタッフ',
+         'menu_name'          => 'スタッフ',
+         'add_new'            => '新規追加',
+         'add_new_item'       => '新規スタッフを追加',
+         'edit_item'          => 'スタッフを編集',
+         'new_item'           => '新規スタッフ',
+         'view_item'          => 'スタッフを表示',
+         'search_items'       => 'スタッフを検索',
+         'not_found'          => 'スタッフが見つかりませんでした',
+         'not_found_in_trash' => 'ゴミ箱にスタッフはありません',
+     );
+     
+     $args = array(
+         'labels'              => $labels,
+         'public'              => true,
+         'has_archive'         => true,
+         'publicly_queryable'  => true,
+         'query_var'           => true,
+         'rewrite'             => array('slug' => 'staff'),
+         'capability_type'     => 'post',
+         'hierarchical'        => false,
+         'supports'            => array('title', 'thumbnail'),
+         'menu_position'       => 5,
+         'menu_icon'           => 'dashicons-groups',
+         'show_in_rest'        => true,
+     );
+     
+     register_post_type('staff', $args);
+ 
+     // スタッフのカテゴリタクソノミーを登録
+     register_taxonomy(
+         'category-staff',
+         'staff',
+         array(
+             'label' => 'スタッフカテゴリー',
+             'hierarchical' => true,
+             'public' => true,
+             'show_in_rest' => true,
+             'rewrite' => array('slug' => 'category-staff')
+         )
+     );
+ }
+ add_action('init', 'register_staff_post_type');
+ 
+ /**
+  * スタッフ用のカスタムフィールドを追加
+  */
+ function add_staff_meta_boxes() {
+     add_meta_box(
+         'staff_details',
+         'スタッフ詳細情報',
+         'staff_details_callback',
+         'staff',
+         'normal',
+         'high'
+     );
+ }
+ add_action('add_meta_boxes', 'add_staff_meta_boxes');
+ 
+ // スタッフ詳細情報のコールバック関数
+ function staff_details_callback($post) {
+     wp_nonce_field(basename(__FILE__), 'staff_nonce');
+     
+     // 保存されている値を取得
+     $subtitle = get_post_meta($post->ID, 'staff_subtitle', true);
+     $description = get_post_meta($post->ID, 'staff_description', true);
+     $history = get_post_meta($post->ID, 'staff_history', true);
+     if (!is_array($history)) {
+         $history = array();
+     }
+     $story = get_post_meta($post->ID, 'staff_story', true);
+     $story_image = get_post_meta($post->ID, 'staff_story_image', true);
+     $reason = get_post_meta($post->ID, 'staff_reason', true);
+     $instagram = get_post_meta($post->ID, 'staff_instagram', true);
+     $twitter = get_post_meta($post->ID, 'staff_twitter', true);
+     $facebook = get_post_meta($post->ID, 'staff_facebook', true);
+     
+     // フォームを表示
+     ?>
+     <p>
+         <label for="staff_subtitle">サブタイトル:</label><br>
+         <input type="text" id="staff_subtitle" name="staff_subtitle" value="<?php echo esc_attr($subtitle); ?>" style="width: 100%;">
+     </p>
+     
+     <p>
+         <label for="staff_description">自己紹介文:</label><br>
+         <textarea id="staff_description" name="staff_description" rows="5" style="width: 100%;"><?php echo esc_textarea($description); ?></textarea>
+     </p>
+     
+     <div class="staff-history-fields">
+         <h4>経歴（複数項目）</h4>
+         <div id="staff_history_items">
+             <?php
+             if (!empty($history)) {
+                 foreach ($history as $i => $item) {
+                     echo '<p><input type="text" name="staff_history[]" value="' . esc_attr($item) . '" style="width: 90%;"> <button type="button" class="remove-history-item button">削除</button></p>';
+                 }
+             } else {
+                 // デフォルトで1つフィールドを表示
+                 echo '<p><input type="text" name="staff_history[]" value="" style="width: 90%;"> <button type="button" class="remove-history-item button">削除</button></p>';
+             }
+             ?>
+         </div>
+         <button type="button" id="add_history_item" class="button">経歴項目を追加</button>
+     </div>
+     
+     <p>
+         <label for="staff_story">ストーリー:</label><br>
+         <textarea id="staff_story" name="staff_story" rows="5" style="width: 100%;"><?php echo esc_textarea($story); ?></textarea>
+     </p>
+     
+     <p>
+         <label for="staff_story_image">ストーリー画像ID:</label><br>
+         <input type="number" id="staff_story_image" name="staff_story_image" value="<?php echo esc_attr($story_image); ?>"><br>
+         <small>メディアライブラリから画像をアップロードし、その画像IDを入力してください。</small>
+     </p>
+     
+     <p>
+         <label for="staff_reason">さくら事務所グループで働く理由:</label><br>
+         <textarea id="staff_reason" name="staff_reason" rows="5" style="width: 100%;"><?php echo esc_textarea($reason); ?></textarea>
+     </p>
+     
+     <h4>SNSリンク</h4>
+     
+     <p>
+         <label for="staff_instagram">Instagram URL:</label><br>
+         <input type="url" id="staff_instagram" name="staff_instagram" value="<?php echo esc_url($instagram); ?>" style="width: 100%;">
+     </p>
+     
+     <p>
+         <label for="staff_twitter">Twitter/X URL:</label><br>
+         <input type="url" id="staff_twitter" name="staff_twitter" value="<?php echo esc_url($twitter); ?>" style="width: 100%;">
+     </p>
+     
+     <p>
+         <label for="staff_facebook">Facebook URL:</label><br>
+         <input type="url" id="staff_facebook" name="staff_facebook" value="<?php echo esc_url($facebook); ?>" style="width: 100%;">
+     </p>
+     
+     <script>
+     jQuery(document).ready(function($) {
+         // 経歴項目を追加するボタンのイベント
+         $('#add_history_item').on('click', function() {
+             $('#staff_history_items').append('<p><input type="text" name="staff_history[]" value="" style="width: 90%;"> <button type="button" class="remove-history-item button">削除</button></p>');
+         });
+         
+         // 経歴項目を削除するボタンのイベント（動的に追加された要素にも対応）
+         $(document).on('click', '.remove-history-item', function() {
+             $(this).parent('p').remove();
+         });
+     });
+     </script>
+     <?php
+ }
+ 
+ // スタッフメタデータの保存
+ function save_staff_meta($post_id) {
+     // 自動保存の場合は何もしない
+     if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
+         return;
+     }
+     
+     // nonceチェック
+     if (!isset($_POST['staff_nonce']) || !wp_verify_nonce($_POST['staff_nonce'], basename(__FILE__))) {
+         return;
+     }
+     
+     // 権限チェック
+     if (!current_user_can('edit_post', $post_id)) {
+         return;
+     }
+     
+     // サブタイトルの保存
+     if (isset($_POST['staff_subtitle'])) {
+         update_post_meta($post_id, 'staff_subtitle', sanitize_text_field($_POST['staff_subtitle']));
+     }
+     
+     // 自己紹介文の保存
+     if (isset($_POST['staff_description'])) {
+         update_post_meta($post_id, 'staff_description', wp_kses_post($_POST['staff_description']));
+     }
+     
+     // 経歴の保存（配列）
+     if (isset($_POST['staff_history'])) {
+         $history = array_map('sanitize_text_field', $_POST['staff_history']);
+         // 空の項目を削除
+         $history = array_filter($history, function($item) {
+             return !empty($item);
+         });
+         update_post_meta($post_id, 'staff_history', $history);
+     }
+     
+     // ストーリーの保存
+     if (isset($_POST['staff_story'])) {
+         update_post_meta($post_id, 'staff_story', wp_kses_post($_POST['staff_story']));
+     }
+     
+     // ストーリー画像IDの保存
+     if (isset($_POST['staff_story_image'])) {
+         update_post_meta($post_id, 'staff_story_image', absint($_POST['staff_story_image']));
+     }
+     
+     // 理由の保存
+     if (isset($_POST['staff_reason'])) {
+         update_post_meta($post_id, 'staff_reason', wp_kses_post($_POST['staff_reason']));
+     }
+     
+     // SNSリンクの保存
+     if (isset($_POST['staff_instagram'])) {
+         update_post_meta($post_id, 'staff_instagram', esc_url_raw($_POST['staff_instagram']));
+     }
+     
+     if (isset($_POST['staff_twitter'])) {
+         update_post_meta($post_id, 'staff_twitter', esc_url_raw($_POST['staff_twitter']));
+     }
+     
+     if (isset($_POST['staff_facebook'])) {
+         update_post_meta($post_id, 'staff_facebook', esc_url_raw($_POST['staff_facebook']));
+     }
+ }
+ add_action('save_post_staff', 'save_staff_meta');
  
  
```

---

カスタムフィールドの設定をfunctions.phpに追加しました。以下の内容が含まれています：

1. **カスタム投稿タイプ「Staff」の登録**
   - スタッフの一覧ページや詳細ページを管理するための投稿タイプを設定
   - アーカイブページやパーマリンク構造も設定済み

2. **カスタムタクソノミー「category-staff」の登録**
   - カテゴリー形式でスタッフを分類できるタクソノミーを追加
   - 階層構造が可能なので、部署や役職などで分類可能

3. **カスタムフィールドのメタボックス設定**
   - スタッフ詳細情報を入力するための編集画面を追加
   - 以下のフィールドが含まれています：
     - サブタイトル
     - 自己紹介文
     - 経歴（複数項目、動的に追加可能）
     - ストーリー
     - ストーリー画像
     - さくら事務所グループで働く理由
     - SNSリンク（Instagram/Twitter/Facebook）

4. **フィールド値の保存処理**
   - 入力されたデータをセキュアに検証・サニタイズして保存
   - 経歴など複数項目の配列データも適切に処理

管理画面にログインしてスタッフ投稿を作成・編集すると、これらのカスタムフィールドが表示され、入力したデータがsingle-staff.phpで参照できるようになります。

---

_**User**_

経歴項目は３つのみで追加はしなくて良いです

---

_**Assistant**_



---

スタッフの経歴項目を3つのみの固定フィールドに変更します。

---



---



---



---

経歴項目を3つの固定フィールドに変更しました。変更点は以下のとおりです：

1. 経歴項目のセクションを「経歴（3項目）」として見出しを変更
2. 3つの固定フィールドを表示するようにコードを修正し、各項目にラベルを追加
3. 「経歴項目を追加」ボタンを削除
4. 項目を追加・削除するためのJavaScriptコードを削除
5. データ保存時のロジックを変更し、空の項目をフィルタリングせず、最大3項目までを保存するように修正

これにより、スタッフ編集画面では常に3つの固定経歴フィールドが表示され、追加ボタンや削除ボタンがなくなります。

---

_**User**_

staff-single__story-item-imgはメディアから選択できるようにしてほしい

---

_**Assistant**_



---

